<Window x:Class="CursorBackup.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:CursorBackup"
        xmlns:vm="clr-namespace:CursorBackup.ViewModels"
        xmlns:conv="clr-namespace:CursorBackup.Converters"
        xmlns:controls="clr-namespace:CursorBackup.Controls"
        mc:Ignorable="d"
        Title="Cursor Backup - Settings Manager" 
        WindowState="Maximized"
        WindowStyle="SingleBorderWindow"
        ResizeMode="CanResize"
        Background="#1E1E1E">
    <Window.Resources>
        <conv:BoolToBrushConverter x:Key="BoolToBrushConverter"/>
        <conv:BoolToStatusConverter x:Key="BoolToStatusConverter"/>
        <conv:BoolToColorConverter x:Key="BoolToColorConverter"/>
        <conv:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <conv:BoolToTextDecorationConverter x:Key="BoolToTextDecorationConverter"/>
        <conv:ChatVisibilityConverter x:Key="ChatVisibilityConverter"/>
    </Window.Resources>
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Modal Preview Overlay -->
        <ContentControl x:Name="ModalPreviewContainer"
                       Grid.Row="0" Grid.RowSpan="4"
                       Panel.ZIndex="2000"
                       Visibility="Collapsed"/>
        
        <!-- Loading Overlay - Blocks entire UI during loading -->
        <Border Grid.Row="0" Grid.RowSpan="4"
               Background="#80000000" 
               Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}"
               Panel.ZIndex="1000">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <Border Grid.Row="1" Grid.Column="1"
                       Background="#2D2D30"
                       BorderBrush="#3F3F46"
                       BorderThickness="2"
                       CornerRadius="5"
                       Padding="30,20">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center">
                        <TextBlock Text="Loading in progress..."
                                  Foreground="#FFFFFF"
                                  FontSize="16"
                                  FontWeight="Bold"
                                  HorizontalAlignment="Center"
                                  Margin="0,0,0,15"/>
                        <TextBlock Text="{Binding ProgressMessage}" 
                                  Foreground="#CCCCCC" 
                                  FontSize="12"
                                  HorizontalAlignment="Center"
                                  Margin="0,0,0,10"/>
                        <ProgressBar Value="{Binding ProgressValue}" 
                                    Maximum="100"
                                    Width="300"
                                    Height="25"
                                    Background="#3F3F46"
                                    Foreground="#007ACC"
                                    BorderThickness="0"/>
                        <TextBlock Text="{Binding ProgressValue, StringFormat='{}{0:F0}%'}" 
                                  Foreground="#FFFFFF" 
                                  FontSize="11"
                                  HorizontalAlignment="Center"
                                  Margin="0,5,0,0"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- Header -->
        <Border Grid.Row="0" Background="#2D2D30" Padding="20">
            <Grid>
                <TextBlock Text="Cursor Backup - Settings Manager" 
                          FontSize="24" 
                          FontWeight="Bold" 
                          Foreground="#FFFFFF" 
                          VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1" Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel - Current Settings -->
            <Border Grid.Column="0" 
                   BorderBrush="#3F3F46" 
                   BorderThickness="1" 
                   Background="#252526" 
                   CornerRadius="5"
                   Padding="15">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" 
                              Text="Current Cursor Settings" 
                              FontSize="18" 
                              FontWeight="Bold" 
                              Foreground="#FFFFFF"
                              Margin="0,0,0,10"/>

                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
                        <Button Content="Load Current Settings" 
                               Command="{Binding LoadCurrentSettingsCommand}"
                               Padding="15,8"
                               Background="#007ACC"
                               Foreground="#FFFFFF"
                               BorderThickness="0"
                               Cursor="Hand"
                               Margin="0,0,5,0"
                               ToolTip="Load current Cursor settings: global settings, keybindings, chat histories"/>
                        <Button Content="Select All" 
                               Command="{Binding SelectAllCommand}"
                               Padding="15,8"
                               Background="#3F3F46"
                               Foreground="#FFFFFF"
                               BorderThickness="0"
                               Cursor="Hand"
                               Margin="0,0,5,0"
                               ToolTip="Select all available settings"/>
                        <Button Content="Deselect All" 
                               Command="{Binding DeselectAllCommand}"
                               Padding="15,8"
                               Background="#3F3F46"
                               Foreground="#FFFFFF"
                               BorderThickness="0"
                               Cursor="Hand"
                               ToolTip="Deselect all"/>
                    </StackPanel>

                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Background="Transparent">
                        <ItemsControl ItemsSource="{Binding Settings}" Background="Transparent">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderBrush="#3F3F46" 
                                           BorderThickness="0,0,0,1" 
                                           Padding="10,8"
                                           Background="{Binding IsAvailable, Converter={StaticResource BoolToBrushConverter}}"
                                           Visibility="{Binding Type, Converter={StaticResource ChatVisibilityConverter}}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <CheckBox Grid.Column="0" 
                                                     IsChecked="{Binding IsSelected}" 
                                                     IsEnabled="{Binding IsAvailable}"
                                                     Margin="0,0,10,0"
                                                     VerticalAlignment="Center"
                                                     Foreground="#FFFFFF"
                                                     ToolTip="{Binding Category}"/>
                                            
                                            <StackPanel Grid.Column="1">
                                                <TextBlock Text="{Binding Name}" 
                                                          FontWeight="Bold"
                                                          FontSize="14"
                                                          Foreground="#FFFFFF"/>
                                                <TextBlock Text="{Binding Description}" 
                                                          Foreground="#CCCCCC"
                                                          FontSize="11"
                                                          TextWrapping="Wrap"/>
                                                <TextBlock Text="{Binding Category}" 
                                                          Foreground="#999999"
                                                          FontSize="10"
                                                          Margin="0,2,0,0"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding IsAvailable, Converter={StaticResource BoolToStatusConverter}}"
                                                          Foreground="{Binding IsAvailable, Converter={StaticResource BoolToColorConverter}}"
                                                          Margin="10,0,10,0"
                                                          VerticalAlignment="Center"/>
                                                <Button Content="👁" 
                                                       Width="30"
                                                       Height="30"
                                                       Click="PreviewButton_Click"
                                                       Tag="{Binding}"
                                                       Background="#3F3F46"
                                                       Foreground="#FFFFFF"
                                                       BorderThickness="0"
                                                       Cursor="Hand"
                                                       ToolTip="Preview settings"
                                                       FontSize="14"
                                                       Padding="0"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Chat Histories Section -->
                    <Expander x:Name="ChatHistoriesExpander"
                             Grid.Row="3" 
                             Header="Chat Histories (by Project)" 
                             Margin="0,10,0,0"
                             IsExpanded="False"
                             Foreground="#FFFFFF"
                             Background="Transparent"
                             Expanded="ChatHistoriesExpander_Expanded"
                             Collapsed="ChatHistoriesExpander_Collapsed">
                        <ScrollViewer MaxHeight="300" 
                                    VerticalScrollBarVisibility="Auto" 
                                    Background="Transparent"
                                    Padding="5,5,5,5">
                                <ItemsControl ItemsSource="{Binding Projects}" Background="Transparent">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Margin="0,3,0,3"
                                                   BorderBrush="#3F3F46"
                                                   BorderThickness="1"
                                                   Background="#2D2D30"
                                                   CornerRadius="3"
                                                   Padding="5">
                                                <Expander Foreground="#FFFFFF"
                                                         Background="Transparent">
                                                    <Expander.IsExpanded>
                                                        <Binding Path="IsExpanded"/>
                                                    </Expander.IsExpanded>
                                                    <Expander.Header>
                                                        <CheckBox Content="{Binding ProjectName}"
                                                                 IsChecked="{Binding IsSelected}"
                                                                 Foreground="#FFFFFF"
                                                                 Background="Transparent"
                                                                 BorderThickness="0"
                                                                 VerticalContentAlignment="Center"
                                                                 FontWeight="SemiBold"/>
                                                    </Expander.Header>
                                                    <ItemsControl ItemsSource="{Binding ChatHistories}" 
                                                                 Background="Transparent"
                                                                 Margin="15,5,0,5">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <Border Margin="0,2,0,2"
                                                                       BorderBrush="#3F3F46"
                                                                       BorderThickness="0,0,0,1"
                                                                       Padding="5,3">
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="*"/>
                                                                            <ColumnDefinition Width="Auto"/>
                                                                        </Grid.ColumnDefinitions>
                                                                        <CheckBox Grid.Column="0"
                                                                                 Content="{Binding ChatName}" 
                                                                                 IsChecked="{Binding IsSelected}"
                                                                                 IsEnabled="{Binding IsAvailable}"
                                                                                 Foreground="#CCCCCC"
                                                                                 FontSize="12"/>
                                                                        <Button Grid.Column="1"
                                                                               Content="👁" 
                                                                               Width="25"
                                                                               Height="25"
                                                                               Click="PreviewChatButton_Click"
                                                                               Tag="{Binding}"
                                                                               Background="#3F3F46"
                                                                               Foreground="#FFFFFF"
                                                                               BorderThickness="0"
                                                                               Cursor="Hand"
                                                                               ToolTip="Preview chat"
                                                                               FontSize="12"
                                                                               Padding="0"
                                                                               Margin="5,0,0,0"/>
                                                                    </Grid>
                                                                </Border>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </Expander>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                    </Expander>

                    <!-- Documentations Section -->
                    <Expander x:Name="DocumentationsExpander"
                             Grid.Row="4" 
                             Header="Documentations (by Group)" 
                             Margin="0,10,0,0"
                             IsExpanded="False"
                             Foreground="#FFFFFF"
                             Background="Transparent"
                             Expanded="DocumentationsExpander_Expanded"
                             Collapsed="DocumentationsExpander_Collapsed">
                        <ScrollViewer MaxHeight="300" 
                                    VerticalScrollBarVisibility="Auto" 
                                    Background="Transparent"
                                    Padding="5,5,5,5">
                                <ItemsControl ItemsSource="{Binding Documentations}" Background="Transparent">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Margin="0,3,0,3"
                                                   BorderBrush="#3F3F46"
                                                   BorderThickness="1"
                                                   Background="#2D2D30"
                                                   CornerRadius="3"
                                                   Padding="5">
                                                <Expander Foreground="#FFFFFF"
                                                         Background="Transparent">
                                                    <Expander.IsExpanded>
                                                        <Binding Path="IsExpanded"/>
                                                    </Expander.IsExpanded>
                                                    <Expander.Header>
                                                        <CheckBox Content="{Binding GroupName}"
                                                                 IsChecked="{Binding IsSelected}"
                                                                 Foreground="#FFFFFF"
                                                                 Background="Transparent"
                                                                 BorderThickness="0"
                                                                 VerticalContentAlignment="Center"
                                                                 FontWeight="SemiBold"/>
                                                    </Expander.Header>
                                                    <ItemsControl ItemsSource="{Binding Documentations}" 
                                                                 Background="Transparent"
                                                                 Margin="15,5,0,5">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <Border Margin="0,2,0,2"
                                                                       BorderBrush="#3F3F46"
                                                                       BorderThickness="0,0,0,1"
                                                                       Padding="5,3">
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="*"/>
                                                                            <ColumnDefinition Width="Auto"/>
                                                                        </Grid.ColumnDefinitions>
                                                                        <CheckBox Grid.Column="0"
                                                                                 Content="{Binding Name}" 
                                                                                 IsChecked="{Binding IsSelected}"
                                                                                 IsEnabled="{Binding IsAvailable}"
                                                                                 Foreground="#CCCCCC"
                                                                                 FontSize="12"/>
                                                                        <Button Grid.Column="1"
                                                                               Content="👁" 
                                                                               Width="25"
                                                                               Height="25"
                                                                               Click="PreviewButton_Click"
                                                                               Tag="{Binding}"
                                                                               Background="#3F3F46"
                                                                               Foreground="#FFFFFF"
                                                                               BorderThickness="0"
                                                                               Cursor="Hand"
                                                                               ToolTip="Preview documentation"
                                                                               FontSize="12"
                                                                               Padding="0"
                                                                               Margin="5,0,0,0"/>
                                                                    </Grid>
                                                                </Border>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </Expander>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                    </Expander>
                </Grid>
            </Border>

            <!-- Right Panel - Loaded from Backup -->
            <Border Grid.Column="2" 
                   BorderBrush="#3F3F46" 
                   BorderThickness="1" 
                   Background="#252526" 
                   CornerRadius="5"
                   Padding="15">
                <controls:SettingsPanel DataContext="{Binding BackupSettingsPanelViewModel}"/>
            </Border>
        </Grid>

        <!-- Footer with Action Buttons -->
        <Border Grid.Row="2" 
               Background="#2D2D30" 
               Padding="20">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" 
                          Text="{Binding StatusMessage}" 
                          Foreground="#FFFFFF" 
                          VerticalAlignment="Center"
                          FontSize="12"/>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Command="{Binding SaveSelectedCommand}"
                           Padding="20,10"
                           Margin="0,0,10,0"
                           FontSize="14"
                           FontWeight="Bold"
                           ToolTip="Save selected settings to specified folder. Overwrites existing files!">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="#0E639C"/>
                                <Setter Property="Foreground" Value="#FFFFFF"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Cursor" Value="Hand"/>
                                <Setter Property="Content" Value="Save Selected to..."/>
                                <Style.Triggers>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter Property="Background" Value="#3F3F46"/>
                                        <Setter Property="Foreground" Value="#999999"/>
                                        <Setter Property="Cursor" Value="Arrow"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <Button.ContentTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}" 
                                          TextDecorations="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=IsEnabled, Converter={StaticResource BoolToTextDecorationConverter}}"
                                          Foreground="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=Foreground}"/>
                            </DataTemplate>
                        </Button.ContentTemplate>
                    </Button>
                    <Button Command="{Binding MergeSelectedCommand}"
                           Padding="20,10"
                           Margin="0,0,10,0"
                           FontSize="14"
                           FontWeight="Bold"
                           ToolTip="Merge selected settings. Does NOT overwrite existing files, only adds new ones. Security confirmation required!">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="#68217A"/>
                                <Setter Property="Foreground" Value="#FFFFFF"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Cursor" Value="Hand"/>
                                <Setter Property="Content" Value="Merge Selected to..."/>
                                <Style.Triggers>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter Property="Background" Value="#3F3F46"/>
                                        <Setter Property="Foreground" Value="#999999"/>
                                        <Setter Property="Cursor" Value="Arrow"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <Button.ContentTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}" 
                                          TextDecorations="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=IsEnabled, Converter={StaticResource BoolToTextDecorationConverter}}"
                                          Foreground="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=Foreground}"/>
                            </DataTemplate>
                        </Button.ContentTemplate>
                    </Button>
                    <Button Command="{Binding ExportChatsCommand}"
                           Padding="20,10"
                           FontSize="14"
                           FontWeight="Bold"
                           ToolTip="Export selected chats to Markdown format, organized in project folders">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="#0E639C"/>
                                <Setter Property="Foreground" Value="#FFFFFF"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Cursor" Value="Hand"/>
                                <Setter Property="Content" Value="Export Chats"/>
                                <Style.Triggers>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter Property="Background" Value="#3F3F46"/>
                                        <Setter Property="Foreground" Value="#999999"/>
                                        <Setter Property="Cursor" Value="Arrow"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <Button.ContentTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}" 
                                          TextDecorations="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=IsEnabled, Converter={StaticResource BoolToTextDecorationConverter}}"
                                          Foreground="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=Foreground}"/>
                            </DataTemplate>
                        </Button.ContentTemplate>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Progress Bar -->
        <Border Grid.Row="3" 
               Background="#2D2D30" 
               Padding="10,5"
               Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel Orientation="Vertical">
                <TextBlock Text="{Binding ProgressMessage}" 
                          Foreground="#FFFFFF" 
                          FontSize="12"
                          FontWeight="SemiBold"
                          Margin="0,0,0,5"/>
                <ProgressBar Value="{Binding ProgressValue}" 
                            Maximum="100"
                            Height="20"
                            Background="#3F3F46"
                            Foreground="#007ACC"
                            BorderThickness="0"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
